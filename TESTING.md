# Command Clinic Raycast - 手動テストガイド

## 概要
このドキュメントは Command Clinic Raycast 拡張機能の手動テスト手順を定義します。MVP 検証のための重要なテストケースを網羅しています。

---

## 前提条件

### 必須設定
- [ ] Raycast がインストールされている
- [ ] Claude API キーを取得済み（https://console.anthropic.com）
- [ ] 拡張機能がビルド済み（`npm run build` または `npm run dev`）

### 推奨環境
- macOS 10.15 以降
- 安定したインターネット接続（Claude API 通信用）

---

## テストケース

### 1. オンボーディングフロー（タスク 11.2 - 要件 10.1）

#### 1.1 初回起動とグローバルショートカット設定
**目的**: 2分以内にセットアップを完了できるか確認

**手順**:
1. Raycast を開く（⌘ + Space）
2. `Onboarding` と入力して Command Clinic のオンボーディングを起動
3. グローバルショートカット（⌥⌘K）の設定ガイダンスを確認
4. Raycast Preferences へのディープリンクをクリック
5. Extensions > Command Clinic > Launcher に ⌥⌘K を設定
6. オンボーディング画面に戻る

**期待結果**:
- [ ] グローバルショートカット設定ガイダンスが明確に表示される
- [ ] ディープリンクが正しく Preferences 画面を開く
- [ ] ショートカット設定が保存される

#### 1.2 エイリアス登録（3つ）
**手順**:
1. オンボーディング画面で「次へ」を選択
2. 推奨エイリアスリストを確認（Search Files, Tile Window, System 3つ）
3. 各エイリアスの詳細を確認：
   - ID（例: `search-files`）
   - 名前（例: `Search Files`）
   - コマンド（例: `raycast://extensions/raycast/raycast/search-files`）
4. 必要に応じてエイリアスを編集
5. 「保存して完了」を選択

**期待結果**:
- [ ] デフォルトで3つのエイリアスが表示される
- [ ] エイリアスの編集が可能
- [ ] 保存成功のトースト通知が表示される
- [ ] `aliases.json` にエイリアスが保存される

#### 1.3 プライバシーポリシー確認
**手順**:
1. オンボーディング画面でプライバシーポリシーセクションを確認

**期待結果**:
- [ ] 「すべてのデータはローカルに保存されます」と明記
- [ ] 「分析は手動トリガーのみ」と明記
- [ ] API キーの安全な管理方法が説明されている

#### 1.4 完了時間の計測
**手順**:
1. オンボーディング開始から完了までの時間を計測

**期待結果**:
- [ ] **2分以内に完了できる**（要件 10.1）

---

### 2. ログ収集機能（タスク 11.2 - 要件 10.2）

#### 2.1 ランチャーの起動と検索
**手順**:
1. グローバルショートカット（⌥⌘K）で Launcher を起動
2. 検索バーに「search」と入力
3. エイリアスリストをフィルタリング

**期待結果**:
- [ ] グローバルショートカットで即座に起動する
- [ ] 検索テキストがリアルタイムでフィルタリングされる
- [ ] 登録済みエイリアスのみが表示される

#### 2.2 コマンド起動とログ記録
**手順**:
1. Launcher で「Search Files」エイリアスを選択
2. Raycast の Search Files 機能が起動することを確認
3. 以下のコマンドでログファイルを確認:
   ```bash
   cat ~/Library/Application\ Support/com.raycast.macos/extensions/command-clinic-raycast/logs-$(date +%Y-%m-%d).jsonl
   ```

**期待結果**:
- [ ] エイリアス選択で正しいコマンドが起動する
- [ ] ログファイルに以下の2つのイベントが記録される：
  - `type: "input"` - 検索テキスト入力イベント
  - `type: "launch"` - コマンド起動イベント
- [ ] JSON 形式が正しい（各行が有効な JSON）

**ログ例**:
```jsonl
{"type":"input","ts":1730275200000,"text":"search","len":6}
{"type":"launch","ts":1730275201000,"aliasId":"search-files","target":{"type":"builtin","command":"search-files","ownerOrAuthorName":"raycast"}}
```

#### 2.3 複数日のログ収集
**手順**:
1. 複数日にわたって Launcher を使用（最低3日間）
2. 各日に異なるコマンドを実行
3. サポートディレクトリを確認:
   ```bash
   ls -la ~/Library/Application\ Support/com.raycast.macos/extensions/command-clinic-raycast/
   ```

**期待結果**:
- [ ] 各日ごとに `logs-YYYY-MM-DD.jsonl` ファイルが作成される
- [ ] 7日より古いファイルは自動削除される
- [ ] ファイルサイズが適切（1イベント≒100バイト）

---

### 3. AI 分析と提案表示（タスク 11.2 - 要件 10.3）

#### 3.1 API キー設定
**手順**:
1. Raycast を開く（⌘ + Space）
2. `Preferences` と入力
3. Extensions > Command Clinic を選択
4. Claude API Key フィールドに有効なキーを入力

**期待結果**:
- [ ] API キーが保存される
- [ ] パスワード形式で表示される（マスク表示）

#### 3.2 分析の実行
**手順**:
1. 最低10回以上のログを収集（上記 2.2, 2.3 参照）
2. Raycast で `Clinic` コマンドを起動
3. ローディング表示を確認
4. 分析完了を待つ（最大10秒）

**期待結果**:
- [ ] ローディング中のインジケーターが表示される
- [ ] API キー未設定時に適切なエラーメッセージが表示される
- [ ] ログ不足時に「データが不十分です」メッセージが表示される
- [ ] 分析成功時に提案カードが表示される（最大3件）

#### 3.3 提案カードの内容確認
**手順**:
1. 表示された提案カードを確認
2. 各提案の詳細を読む

**期待結果**:
提案カードに以下の情報が含まれる:
- [ ] **タイプ**: `shortcut`, `snippet`, `macro` のいずれか
- [ ] **タイトル**: 提案の概要（日本語）
- [ ] **根拠**: 提案理由（最大80文字）
- [ ] **証拠データ**:
  - エイリアスリスト
  - 頻度（カウント）
  - 時間帯（HH:MM-HH:MM JST）
- [ ] **信頼度スコア**: 0.0～1.0
- [ ] **アクション**: テンプレートコピー、設定へ移動

**提案例**:
```
🎯 ショートカット提案

Search Files の頻度が高いです

根拠: 7日間で15回起動、平均して毎日使用
証拠:
  • エイリアス: search-files
  • 頻度: 15回/7日
  • 時間帯: 09:00-18:00 JST
信頼度: 0.85

[テンプレートをコピー] [設定を開く]
```

---

### 4. 最適化アクション支援（タスク 11.2 - 要件 10.4）

#### 4.1 ショートカットテンプレート
**手順**:
1. ショートカット提案カードで「テンプレートをコピー」を選択
2. クリップボードの内容を確認

**期待結果**:
- [ ] ガイダンステキストがクリップボードにコピーされる
- [ ] 成功のトースト通知が表示される
- [ ] テキストに以下が含まれる:
  - Raycast Preferences への移動手順
  - ショートカットキーの設定方法
  - 推奨キー（例: ⌥⌘K）

#### 4.2 スニペットテンプレート
**手順**:
1. スニペット提案カードで「テンプレートをコピー」を選択
2. クリップボードの内容を確認

**期待結果**:
- [ ] YAML 形式のテンプレートがコピーされる
- [ ] 以下の情報が含まれる:
  ```yaml
  - name: "スニペット名"
    keyword: "短縮形"
    text: "展開されるテキスト"
  ```

#### 4.3 マクロテンプレート
**手順**:
1. マクロ提案カードで「テンプレートをコピー」を選択
2. クリップボードの内容を確認

**期待結果**:
- [ ] Shell スクリプト形式のテンプレートがコピーされる
- [ ] `launchCommand` API を使用したシーケンスが記述されている
- [ ] コメント付きで分かりやすい

#### 4.4 ディープリンク
**手順**:
1. 提案カードで「設定を開く」を選択

**期待結果**:
- [ ] Raycast Preferences が自動的に開く
- [ ] 該当する設定画面に遷移する

---

### 5. エイリアス管理（タスク 11.2 - 要件 10.5）

#### 5.1 エイリアスリストの表示
**手順**:
1. Raycast で `Manage Aliases` コマンドを起動
2. 登録済みエイリアスを確認

**期待結果**:
- [ ] すべての登録済みエイリアスが表示される
- [ ] エイリアス ID、名前、コマンドタイプが確認できる
- [ ] 検索バーでフィルタリングできる

#### 5.2 新規エイリアスの追加
**手順**:
1. Manage Aliases で「新規追加」を選択
2. フォームに以下を入力:
   - ID: `test-alias`
   - 名前: `Test Command`
   - コマンド: `raycast://extensions/raycast/raycast/search-files`
3. 保存

**期待結果**:
- [ ] バリデーションエラーがない場合、保存される
- [ ] 重複 ID の場合、エラーメッセージが表示される
- [ ] 20件上限に達している場合、エラーメッセージが表示される
- [ ] 保存成功のトースト通知が表示される

#### 5.3 エイリアスの編集
**手順**:
1. Manage Aliases でエイリアスを選択
2. 「編集」アクションを選択
3. 名前を変更
4. 保存

**期待結果**:
- [ ] 編集内容が保存される
- [ ] Launcher で変更が反映される

#### 5.4 エイリアスの削除
**手順**:
1. Manage Aliases でエイリアスを選択
2. 「削除」アクションを選択
3. 確認ダイアログで「削除」を選択

**期待結果**:
- [ ] 確認ダイアログが表示される
- [ ] 削除後、リストから消える
- [ ] Launcher からも消える

---

### 6. データ管理とプライバシー（タスク 11.2 - 要件 10.6）

#### 6.1 ログファイルの表示
**手順**:
1. Raycast で `Clear Logs` コマンドを起動
2. 「ログファイルを読み込み」を実行

**期待結果**:
- [ ] すべてのログファイルが一覧表示される
- [ ] ファイル名、日付、サイズが表示される
- [ ] 新しい順にソートされている

#### 6.2 個別ログファイルの削除
**手順**:
1. Clear Logs でログファイルを選択
2. ⌘ + Delete で削除
3. 確認ダイアログで「削除」を選択

**期待結果**:
- [ ] 確認ダイアログが表示される
- [ ] 削除後、リストから消える
- [ ] ファイルシステムから削除される

#### 6.3 すべてのログの削除
**手順**:
1. Clear Logs で「すべて削除」を実行
2. 確認ダイアログで「削除」を選択

**期待結果**:
- [ ] 破壊的アクションの警告が表示される
- [ ] すべてのログファイルが削除される
- [ ] 削除件数が通知される

#### 6.4 自動削除の確認
**手順**:
1. 8日以上前のログファイルを手動で作成（テスト用）:
   ```bash
   touch ~/Library/Application\ Support/com.raycast.macos/extensions/command-clinic-raycast/logs-2025-10-01.jsonl
   ```
2. Clinic コマンドを実行（自動削除トリガー）
3. サポートディレクトリを確認

**期待結果**:
- [ ] 7日より古いファイルが自動削除される
- [ ] コンソールログに削除メッセージが記録される

---

### 7. エラーハンドリング（タスク 11.2 - 要件 10.7）

#### 7.1 API キー未設定エラー
**手順**:
1. Raycast Preferences で API キーをクリア
2. Clinic コマンドを実行

**期待結果**:
- [ ] 詳細なエラーメッセージが表示される:
  ```
  Claude API キーが設定されていません。

  **設定方法**:
  1. Raycast を開く（⌘ + Space）
  2. 'Preferences' と入力
  3. 'Extensions' > 'Command Clinic' を選択
  4. 'Claude API Key' フィールドにキーを入力
  5. API キーは https://console.anthropic.com で取得できます
  ```

#### 7.2 API レート制限エラー
**手順**:
1. Clinic コマンドを連続して5回実行（1秒以内）

**期待結果**:
- [ ] レート制限エラーメッセージが表示される:
  ```
  APIレート制限に達しました。

  **対処法**:
  - 1分待ってから再試行してください
  - 連続して分析を実行しすぎている可能性があります
  ```

#### 7.3 ネットワークタイムアウトエラー
**手順**:
1. ネットワーク接続を一時的に無効化
2. Clinic コマンドを実行

**期待結果**:
- [ ] タイムアウトエラーが表示される（10秒後）
- [ ] 「API request timed out. Please try again.」メッセージ

#### 7.4 ファイルシステムエラー
**手順**:
1. サポートディレクトリの書き込み権限を削除:
   ```bash
   chmod 444 ~/Library/Application\ Support/com.raycast.macos/extensions/command-clinic-raycast/
   ```
2. Launcher でコマンドを実行

**期待結果**:
- [ ] ファイル書き込みエラーのトースト通知が表示される
- [ ] コンソールログにエラーが記録される

**後処理**:
```bash
chmod 755 ~/Library/Application\ Support/com.raycast.macos/extensions/command-clinic-raycast/
```

#### 7.5 破損したログファイル
**手順**:
1. 手動で破損したログファイルを作成:
   ```bash
   echo "invalid json line" >> ~/Library/Application\ Support/com.raycast.macos/extensions/command-clinic-raycast/logs-$(date +%Y-%m-%d).jsonl
   ```
2. Clinic コマンドを実行

**期待結果**:
- [ ] 破損した行はスキップされる
- [ ] 他の有効な行は正常に処理される
- [ ] コンソールログに警告が記録される

---

## パフォーマンステスト

### 8.1 ランチャーの応答速度
**目的**: ユーザー体験を損なわない速度を確認

**手順**:
1. Launcher を起動
2. 検索テキストを入力
3. エイリアスを選択して起動

**期待結果**:
- [ ] Launcher 起動: 1秒以内
- [ ] 検索フィルタリング: リアルタイム（遅延なし）
- [ ] コマンド起動: 2秒以内

### 8.2 分析処理時間
**手順**:
1. 100件のログを準備
2. Clinic コマンドで分析を実行
3. 完了までの時間を計測

**期待結果**:
- [ ] 分析完了: 10秒以内
- [ ] タイムアウトエラーなし

---

## 互換性テスト

### 9.1 Raycast 標準機能の起動
**手順**:
1. 以下の標準機能をエイリアス経由で起動:
   - Search Files
   - Tile Window
   - System (Sleep/Restart/Shutdown)

**期待結果**:
- [ ] すべての標準機能が正しく起動する
- [ ] ログに記録される

### 9.2 サードパーティ拡張の起動
**手順**:
1. サードパーティ拡張をインストール（例: GitHub, Notion）
2. エイリアスを追加
3. Launcher から起動

**期待結果**:
- [ ] サードパーティ拡張が起動する
- [ ] ログに記録される
- [ ] 起動失敗時にフォールバックエラーが表示される

---

## セキュリティテスト

### 10.1 API キーの保護
**手順**:
1. Raycast Preferences で API キーを確認
2. アプリケーションログを確認

**期待結果**:
- [ ] API キーがマスク表示される
- [ ] ログにプレーンテキストで記録されない

### 10.2 ローカルデータの確認
**手順**:
1. サポートディレクトリの内容を確認
2. ネットワークトラフィックを監視（任意）

**期待結果**:
- [ ] すべてのログがローカルに保存される
- [ ] Claude API 以外への通信がない

---

## 回帰テスト（バグ修正後）

### 11.1 デフォルトエイリアスの修正確認
**背景**: P1 バグ修正 - `/lib/aliases.ts` のコマンド ID が誤っていた

**手順**:
1. 新規インストール状態でオンボーディングを完了
2. Launcher でデフォルトエイリアスを起動:
   - Search Files → `raycast://extensions/raycast/raycast/search-files`
   - Tile Window → `raycast://extensions/raycast/raycast/tile-window`

**期待結果**:
- [ ] Search Files が正しく起動する（誤: `index` → 正: `search-files`）
- [ ] Tile Window が正しく起動する（誤: `left-half` → 正: `tile-window`）
- [ ] ログに正しいコマンド ID が記録される

---

## テスト完了チェックリスト

### MVP 検証項目
- [ ] オンボーディングが2分以内に完了する（要件 10.1）
- [ ] ログ収集が正確に動作する（要件 10.2）
- [ ] AI 分析と提案表示が正常に機能する（要件 10.3）
- [ ] 最適化アクションが実行できる（要件 10.4）
- [ ] エイリアス管理が動作する（要件 10.5）
- [ ] データ管理機能が動作する（要件 10.6）
- [ ] エラーケースが適切に処理される（要件 10.7）

### 品質基準
- [ ] すべての P0 バグが修正されている
- [ ] すべての P1 バグが修正されている
- [ ] ユーザー体験が良好（速度、エラーメッセージ）
- [ ] セキュリティ要件を満たしている
- [ ] ドキュメントが整備されている

---

## トラブルシューティング

### ビルドエラー
```bash
# TypeScript エラーを確認
npm run lint

# 依存関係を再インストール
rm -rf node_modules
npm install
```

### ログファイルが作成されない
```bash
# サポートディレクトリの権限を確認
ls -la ~/Library/Application\ Support/com.raycast.macos/extensions/command-clinic-raycast/

# 権限を修正
chmod 755 ~/Library/Application\ Support/com.raycast.macos/extensions/command-clinic-raycast/
```

### API 呼び出しが失敗する
1. API キーが正しく設定されているか確認
2. ネットワーク接続を確認
3. Anthropic のステータスページを確認: https://status.anthropic.com

---

## テストレポート記入

### テスト実施日
- 日付: __________
- テスター: __________
- Raycast バージョン: __________

### 結果サマリー
- 合格: _____ / 合計: _____
- 不合格: _____
- 未実施: _____

### 発見されたバグ
| ID | 重要度 | 説明 | 再現手順 | ステータス |
|----|--------|------|----------|-----------|
|    |        |      |          |           |

### コメント
```
[テスト全体の所見、改善提案などを記入]
```
