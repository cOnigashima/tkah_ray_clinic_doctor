# 実装計画

## Command Critic Raycast 拡張機能 - 実装タスク

### 概要
5時間のハッカソンスコープで Command Critic Raycast 拡張機能を実装します。ユーザーの操作ログを収集し、AI分析により最適化提案を生成する機能を構築します。

---

## 実装タスク

- [ ] 1. プロジェクトの基礎設定とディレクトリ構造の確立
- [ ] 1.1 Raycast 拡張機能プロジェクトの初期化
  - Raycast Create Extension コマンドでプロジェクト生成
  - package.json の設定（名前、説明、コマンド定義）
  - TypeScript 設定とビルド環境の確認
  - 必要な依存関係（node-fetch等）のインストール
  - _Requirements: 全要件の基盤設定_

- [ ] 1.2 ディレクトリ構造とベース型定義の作成
  - src/, lib/, types/ ディレクトリの作成
  - 基本的な型定義（InputEvent, LaunchEvent, Alias, Proposal）の実装
  - LaunchTarget 型の統一定義
  - エラー処理用の共通型とエラー重要度の定義
  - _Requirements: 全要件の型安全性確保_

- [ ] 2. データ永続化層の実装
- [ ] 2.1 ログマネージャーの基本機能実装
  - environment.supportPath を使用したファイルパス管理
  - 入力イベントの JSONL 形式での追記機能
  - 起動イベントの JSONL 形式での追記機能
  - 日次パーティション（logs-YYYY-MM-DD.jsonl）の自動作成
  - _Requirements: 2.1, 2.2, 2.3, 2.4_

- [ ] 2.2 ログ読み込みと管理機能の実装
  - 過去7日間のログファイル読み込み機能
  - 最大100件制限での効率的なデータ取得
  - 7日以上前のファイル自動削除機能
  - ファイルシステムエラーのハンドリング（Toast通知付き）
  - _Requirements: 2.5, 2.6, 2.9, 3.2, 3.3_

- [ ] 3. エイリアス管理システムの構築
- [ ] 3.1 エイリアス設定の永続化機能
  - aliases.json ファイルの読み書き機能
  - デフォルトエイリアスの初期設定（Raycast標準機能）
  - エイリアスの追加・削除・更新機能
  - 重複チェックと上限管理（最大20エイリアス）
  - _Requirements: 7.1, 7.2, 7.3, 7.4, 7.5_

- [ ] 3.2 エイリアス管理UIコンポーネント
  - エイリアスリストの表示機能
  - 新規エイリアス追加フォーム
  - エイリアス編集・削除アクション
  - バリデーションエラーの表示
  - _Requirements: 7.6, 7.7_

- [ ] 4. オンボーディングフローの実装
- [ ] 4.1 初期設定画面の開発
  - グローバルショートカット設定ガイダンス（⌥⌘K推奨）
  - フォームベースのセットアップ画面構築
  - Raycast標準機能の推奨エイリアス表示
  - 設定保存とPreferences統合
  - _Requirements: 1.1, 1.2, 1.3, 1.4_

- [ ] 4.2 エイリアス登録ステップの実装
  - 3つのエイリアス登録を促すUI
  - 必須フィールドのバリデーション機能
  - 許可プロンプトに関するガイダンス表示
  - 2分以内完了を目指したフロー最適化
  - _Requirements: 1.5, 1.6, 1.7, 1.8_

- [ ] 5. ログ収集ランチャーの開発
- [ ] 5.1 検索バーとリスト表示の実装
  - Raycast List コンポーネントの設定
  - 検索テキスト入力時のイベントキャプチャ
  - エイリアスリストの動的表示
  - リアルタイムフィルタリング機能
  - _Requirements: 2.1, 6.7_

- [ ] 5.2 コマンド起動とログ記録の統合
  - エイリアス選択時のイベントキャプチャ
  - launchCommand API による Raycast標準機能の起動
  - サードパーティ拡張の起動（フォールバック付き）
  - 非同期ログ書き込みの実装（キューイング対応）
  - _Requirements: 2.2, 2.7, 6.1, 6.2, 6.3, 6.4_

- [ ] 6. Claude API 統合層の実装
- [ ] 6.1 API クライアントの基本実装
  - Raycast Preferences からの API キー取得
  - プロンプト構築機能（生ログを含む）
  - Claude API へのリクエスト送信機能
  - レート制限対策（最小1秒間隔）の実装
  - _Requirements: 3.4, 3.5, 3.6, 8.4_

- [ ] 6.2 レスポンス処理とエラーハンドリング
  - JSON レスポンスのパース機能
  - 提案配列の抽出と検証
  - API エラーの適切なハンドリング（401, 429, 500）
  - ネットワークタイムアウト処理（10秒）
  - _Requirements: 3.7, 3.8, 3.9, 9.2, 9.3, 9.4_

- [ ] 7. AI 分析結果表示機能の開発
- [ ] 7.1 分析トリガーと結果取得
  - /command-critic コマンドの実装
  - ログデータ読み込みと前処理
  - Claude API 呼び出しとローディング表示
  - 最大3件の提案に制限
  - _Requirements: 3.1, 3.10, 3.11, 4.6_

- [ ] 7.2 提案カードのUI実装
  - Raycast Detail ビューでの Markdown 表示
  - 提案タイプ（shortcut/snippet/macro）の表示
  - 証拠データ（頻度、時間帯）の表示
  - 信頼度スコアの視覚化
  - _Requirements: 4.1, 4.2, 4.3, 4.4, 4.5, 4.7, 4.8_

- [ ] 8. 最適化アクション支援機能の実装
- [ ] 8.1 テンプレート生成機能
  - スニペット定義の YAML 形式生成
  - マクロテンプレートの Shell スクリプト生成
  - ショートカットガイドのフォーマット機能
  - エラー時のフォールバック処理
  - _Requirements: 5.1, 5.2, 5.3, 5.4, 5.7_

- [ ] 8.2 コピーアクションとディープリンク
  - クリップボードへのテンプレートコピー機能
  - Raycast 設定画面へのディープリンク実装
  - 適用ガイダンスの表示
  - アクション失敗時のエラー表示
  - _Requirements: 5.5, 5.6, 5.8_

- [ ] 9. セキュリティとプライバシー機能の実装
- [ ] 9.1 データ保護とプライバシー設定
  - ローカルファーストの保存確認
  - API キーの安全な管理（Preferences経由）
  - オンボーディングでのプライバシーポリシー表示
  - ユーザー制御による分析トリガー
  - _Requirements: 8.1, 8.2, 8.3, 8.4, 8.5_

- [ ] 9.2 データ管理コマンドの実装
  - ログファイル自動削除の確認
  - 手動データ削除コマンドの実装
  - ファイルアクセス権限の確認
  - セキュリティ関連のログ記録
  - _Requirements: 8.6, 8.7_

- [ ] 10. エラーハンドリングとユーザー体験の改善
- [ ] 10.1 包括的なエラー処理の実装
  - ファイルシステムエラーの適切な処理
  - API キー未設定時のガイダンス表示
  - ログファイル破損時のスキップ処理
  - 重大エラー時の再試行・スキップオプション
  - _Requirements: 9.1, 9.5, 9.6, 9.7_

- [ ] 10.2 ユーザーフィードバックの改善
  - ログデータ不足時の適切なメッセージ
  - 分析中のプログレス表示
  - エラー時のトラブルシューティングガイド
  - 成功時の確認メッセージ
  - _Requirements: 9.2, 9.3, 9.4_

- [ ] 11. 統合とシステムテスト
- [ ] 11.1 コンポーネント間の統合
  - ランチャーとログマネージャーの接続確認
  - 分析フローのエンドツーエンド動作確認
  - エイリアス管理と起動機能の統合テスト
  - オンボーディング完了後の動作確認
  - _Requirements: 全要件の統合確認_

- [ ] 11.2 手動テストとMVP検証
  - オンボーディングフローの2分以内完了確認
  - ログ収集の正確性検証
  - AI分析と提案表示の動作確認
  - エラーケースの網羅的テスト
  - _Requirements: 10.1, 10.2, 10.3, 10.4, 10.5, 10.6, 10.7_

---

## 実装順序の推奨事項

1. **基盤構築（タスク1-2）**: プロジェクト設定とデータ層を最初に確立
2. **コア機能（タスク3-6）**: エイリアス管理、オンボーディング、ログ収集、API統合を順次実装
3. **UI実装（タスク7-8）**: 分析結果表示と最適化アクション支援
4. **品質向上（タスク9-11）**: セキュリティ、エラーハンドリング、統合テスト

## MVP スコープの制約

- テストコードは省略（手動テストのみ）
- 高度なエラー回復は基本実装のみ
- UIは Raycast デフォルトコンポーネントを使用
- パフォーマンス最適化は後回し